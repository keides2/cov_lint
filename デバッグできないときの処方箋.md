# VS Code拡張機能（COVLint）デバッグ環境構築 顛末記

## 問題の発生

VS Code拡張機能 COVLint のデバッグを開始しようとした際、以下の複数の問題が発生：

1. **PowerShell実行ポリシーエラー**
2. **TypeScriptコンパイラ（tsc）が見つからないエラー**
3. **TypeScriptコンパイルエラー（46個のエラー）**

## 問題1: PowerShell実行ポリシーエラー

### 症状
```
npm : このシステムではスクリプトの実行が無効になっているため、ファイル C:\Program Files\nodejs\npm.ps1 を読み込むことができません。
```

### 原因
- Windows PowerShellの実行ポリシーがスクリプト実行を制限
- 企業環境やセキュリティ設定による制限

### 試行した解決方法
```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

### 結果
- 上位レベルのポリシーにより上書きされ、効果なし
- 実行ポリシーは既にBypassに設定されていることが判明
  - 実際は
    ```powershell
    Set-ExecutionPolicy -ExecutionPolicy Bypass
    ```
    を実行した


### 実際の原因
PowerShell自体の問題ではなく、後述のtscコマンドの問題だった

## 問題2: TypeScriptコンパイラが見つからない

### 症状
```
'tsc' は、内部コマンドまたは外部コマンド、操作可能なプログラムまたはバッチ ファイルとして認識されていません。
```

### 原因
- TypeScriptがグローバルにインストールされていない
- または、PATHに含まれていない

### 解決方法
```cmd
npm install -g typescript
```

### 確認
```cmd
tsc --version
# Version 5.8.3
```

## 問題3: TypeScriptコンパイルエラー（46個）

### 症状
```cmd
npm run watch
# [12:13:44] Found 46 errors. Watching for file changes.
```

### 詳細エラー内容
- `Cannot find module 'vscode'`
- `Cannot find module 'vscode-languageclient/node'`
- `Cannot find module 'vscode-languageserver/node'`
- `Cannot find module 'fs'`, `'path'`, `'iconv-lite'`, `'csv-parse/sync'`
- `Cannot find name 'process'`
- その他、型定義の不足

### 原因分析
VS Code拡張機能の典型的な構造：
```
cov_lint/
├── package.json (ルート)
├── client/
│   ├── package.json (クライアント側の依存関係)
│   └── src/
└── server/
    ├── package.json (サーバー側の依存関係)
    └── src/
```

**根本原因**: `client/package.json`と`server/package.json`は存在していたが、**依存関係の定義が不完全**だった

### 実際に修正した内容

#### client/package.json の修正内容

既存のファイルの依存関係を以下のように更新：

**修正前（推測される状態）:**
```json
{
  "name": "covlint-client",
  "dependencies": {
    // 不完全な依存関係定義
  },
  "devDependencies": {
    // 型定義の不足
  }
}
```

**修正後（実際の内容）:**
```json
{
  "name": "covlint-client",
  "description": "COVLint client",
  "license": "MIT",
  "version": "0.4.0",
  "repository": {
    "type": "git",
    "url": "https://github.com/keides2/cov_lint"
  },
  "engines": {
    "vscode": "^1.75.0"
  },
  "dependencies": {
    "glob": "^11.0.3",
    "merge-options": "^3.0.4",
    "vscode-languageclient": "^8.1.0"
  },
  "devDependencies": {
    "@types/mocha": "^10.0.10",
    "@types/node": "^24.0.13",
    "@types/vscode": "^1.102.0"
  }
}
```

**主要な追加・更新項目:**
- ✅ `vscode-languageclient`: "^8.1.0" - Language Server Protocolクライアント
- ✅ `@types/vscode`: "^1.102.0" - VS Code API型定義
- ✅ `@types/node`: "^24.0.13" - Node.js型定義  
- ✅ `@types/mocha`: "^10.0.10" - Mochaテスト型定義
- ✅ `glob`: "^11.0.3" - ファイルパターンマッチング

#### server/package.json の修正内容

**推定される修正（server側の依存関係）:**
```json
{
  "name": "covlint-server",
  "description": "COVLint server", 
  "version": "0.4.0",
  "dependencies": {
    "vscode-languageserver": "^8.1.0",
    "vscode-languageserver-textdocument": "^1.0.8",
    "iconv-lite": "^0.6.3",
    "csv-parse": "^5.5.2"
  },
  "devDependencies": {
    "@types/node": "^16.18.34"
  }
}
```

### 解決手順

#### 1. 依存関係のインストール
```cmd
npm run postinstall
```

#### 2. コンパイル確認
```cmd
npm run compile
```

## 最終的な解決

上記の依存関係修正により、全46個のTypeScriptコンパイルエラーが解消され、正常にデバッグ環境が構築された。

## 解決されたエラーの詳細

依存関係の修正により解決されたエラー：

1. ❌ `Cannot find module 'vscode'` → ✅ `@types/vscode`追加で解決
2. ❌ `Cannot find module 'vscode-languageclient/node'` → ✅ `vscode-languageclient`追加で解決
3. ❌ `Cannot find module 'vscode-languageserver/node'` → ✅ `vscode-languageserver`追加で解決
4. ❌ `Cannot find name 'process'` → ✅ `@types/node`追加で解決
5. ❌ `Cannot find name 'Thenable'` → ✅ `@types/vscode`追加で解決
6. ❌ Mochaテスト関連エラー → ✅ `@types/mocha`追加で解決

## 今後の再発防止策

### 1. 環境構築チェックリスト
- [ ] TypeScriptがグローバルにインストールされているか確認
- [ ] `client/package.json`と`server/package.json`が存在するか確認
- [ ] **重要**: 必要な依存関係が正しく定義されているか確認
- [ ] 各サブプロジェクトで`npm install`が正常に完了するか確認

### 2. 定期的なメンテナンス
```cmd
# 依存関係の再インストール
npm run postinstall

# コンパイル確認
npm run compile

# デバッグ前の動作確認
npm run watch
```

### 3. バージョン管理と依存関係管理
- `client/package.json`と`server/package.json`をGitで管理
- 依存関係のバージョンを適切に固定
- **新規環境での初回セットアップ時は必ず依存関係を確認**

### 4. 依存関係確認のベストプラクティス
```cmd
# 各サブディレクトリで依存関係を個別確認
PS C:\Users\HP\Docs\Security\cov_lint> cd client          
PS C:\Users\HP\Docs\Security\cov_lint\client> npm ls             
covlint-client@0.4.0 C:\Users\HP\Docs\Security\cov_lint\client
├── @types/mocha@10.0.10
├── @types/node@24.0.13
├── @types/vscode@1.102.0
├── glob@11.0.3
├── merge-options@3.0.4
└── vscode-languageclient@8.1.0

PS C:\Users\HP\Docs\Security\cov_lint\client> cd ../server
PS C:\Users\HP\Docs\Security\cov_lint\server> npm ls      
covlint-server@0.4.0 C:\Users\HP\Docs\Security\cov_lint\server
├── @types/node@24.0.13
├── csv-parse@6.0.0
├── iconv-lite@0.6.3
├── vscode-languageserver-textdocument@1.0.12
├── vscode-languageserver@8.1.0
└── vscode@1.1.37

# 不足している依存関係の確認
PS C:\Users\HP\Docs\Security\cov_lint\server> npm audit
# npm audit report

brace-expansion  1.0.0 - 1.1.11
brace-expansion Regular Expression Denial of Service vulnerability - https://github.com/advisories/GHSA-v6h2-p8h4-qcjw
fix available via `npm audit fix`
node_modules/brace-expansion

minimatch  <3.0.5
Severity: high
minimatch ReDoS vulnerability - https://github.com/advisories/GHSA-f8q6-p94x-37v3
fix available via `npm audit fix`
node_modules/mocha/node_modules/minimatch
  mocha  1.21.5 - 9.2.1
  Depends on vulnerable versions of minimatch
  Depends on vulnerable versions of mkdirp
  node_modules/mocha
    vscode  >=1.1.35
    Depends on vulnerable versions of mocha
    node_modules/vscode

minimist  <=0.2.3
Severity: critical
Prototype Pollution in minimist - https://github.com/advisories/GHSA-vh95-rmgr-6w4m
Prototype Pollution in minimist - https://github.com/advisories/GHSA-xvch-5gv4-984h
fix available via `npm audit fix`
node_modules/minimist
  mkdirp  0.4.1 - 0.5.1
  Depends on vulnerable versions of minimist
  node_modules/mkdirp

6 vulnerabilities (1 low, 2 high, 3 critical)

To address all issues, run:
  npm audit fix
```

## 学んだ教訓

1. **ファイルの存在 ≠ 正しい設定**
   - `package.json`が存在していても、依存関係の定義が不完全な場合がある
   - ファイルの存在確認だけでなく、**内容の妥当性確認**が重要

2. **VS Code拡張機能の構造理解の重要性**
   - Language Server Protocolを使用する拡張機能は、クライアント・サーバー分離構造
   - 各サブプロジェクトに独自の完全なpackage.jsonが必要

3. **エラーの段階的解決**
   - 表面的なエラー（PowerShell）に惑わされず、根本原因を特定
   - 依存関係の不足が多くのコンパイルエラーの原因

4. **開発環境の再現性**
   - 依存関係を明確に定義し、セットアップ手順を文書化
   - `postinstall`スクリプトによる自動化の活用
   - **既存プロジェクトでも依存関係の見直しが必要な場合がある**

## プロジェクト構成の確認

現在のルートpackage.jsonの重要な設定：

```json
{
  "main": "./client/out/extension",
  "scripts": {
    "compile": "tsc -b client/tsconfig.json server/tsconfig.json",
    "watch": "tsc -b -w client/tsconfig.json server/tsconfig.json",
    "postinstall": "cd client && npm install && cd ../server && npm install && cd .."
  }
}
```

この設定により、クライアント・サーバー構造が正しく管理されている。

## 結論

今回の問題は、**プロジェクトファイルは存在していたが、依存関係の定義が不完全**だったことが根本原因でした。VS Code拡張機能開発では、単純なファイル存在確認だけでなく、依存関係の内容確認が重要であることが判明しました。